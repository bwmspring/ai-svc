<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>强制下线机制流程图</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .flowchart {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: 40px 0;
    }

    .step {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 10px;
      padding: 15px 25px;
      min-width: 200px;
      text-align: center;
      font-weight: bold;
      position: relative;
    }

    .step.decision {
      background: #fff3e0;
      border-color: #ff9800;
      clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
      padding: 20px 40px;
    }

    .step.action {
      background: #e8f5e8;
      border-color: #4caf50;
      border-radius: 5px;
    }

    .step.danger {
      background: #ffebee;
      border-color: #f44336;
    }

    .arrow {
      font-size: 24px;
      color: #666;
    }

    .arrow-branch {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 600px;
    }

    .branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .branch-label {
      font-size: 14px;
      color: #666;
      background: #f5f5f5;
      padding: 5px 10px;
      border-radius: 15px;
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      padding: 15px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }

    .highlight {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px;
      margin: 10px 0;
    }

    .example {
      background: #d4edda;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 20px 0;
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 30px 0;
    }

    .timeline-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }

    .timeline-number {
      background: #007bff;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }

    .device-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .device-card {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .device-card.active {
      border-color: #28a745;
      background: #d4edda;
    }

    .device-card.kicked {
      border-color: #dc3545;
      background: #f8d7da;
    }

    .device-card.new {
      border-color: #007bff;
      background: #d1ecf1;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>强制下线机制流程图</h1>

    <div class="highlight">
      <strong>核心原理：</strong>当用户设备数量超过限制时，系统自动踢出最旧的设备，确保新设备能够正常登录。
    </div>

    <h2>1. 完整流程图</h2>
    <div class="flowchart">
      <div class="step">用户新设备登录</div>
      <div class="arrow">⬇</div>
      <div class="step">检查设备是否已存在</div>
      <div class="arrow">⬇</div>
      <div class="step decision">设备已存在？</div>

      <div class="arrow-branch">
        <div class="branch">
          <div class="branch-label">是</div>
          <div class="step action">更新设备信息</div>
          <div class="step action">登录成功</div>
        </div>
        <div class="branch">
          <div class="branch-label">否</div>
          <div class="step">检查设备数量限制</div>
          <div class="arrow">⬇</div>
          <div class="step decision">设备数量 ≥ 上限？</div>
        </div>
      </div>

      <div class="arrow-branch">
        <div class="branch">
          <div class="branch-label">否</div>
          <div class="step action">直接创建新设备</div>
          <div class="step action">登录成功</div>
        </div>
        <div class="branch">
          <div class="branch-label">是</div>
          <div class="step danger">触发强制下线</div>
          <div class="arrow">⬇</div>
          <div class="step danger">获取用户所有设备</div>
          <div class="arrow">⬇</div>
          <div class="step danger">按最后活跃时间排序</div>
          <div class="arrow">⬇</div>
          <div class="step danger">选择最旧设备</div>
          <div class="arrow">⬇</div>
          <div class="step danger">删除设备会话</div>
          <div class="arrow">⬇</div>
          <div class="step danger">删除设备记录</div>
          <div class="arrow">⬇</div>
          <div class="step action">创建新设备</div>
          <div class="arrow">⬇</div>
          <div class="step action">登录成功</div>
        </div>
      </div>
    </div>

    <h2>2. 关键代码实现</h2>
    <div class="code-block">
      // 检查设备数量限制
      func (s *deviceService) CheckDeviceLimit(userID uint) error {
      count, err := s.deviceRepo.CountUserDevices(userID)
      if err != nil {
      return err
      }

      if int(count) >= s.maxDevices {
      // 踢出最旧的设备
      if err := s.KickOldestDevice(userID); err != nil {
      return errors.New("设备数量已达上限，且无法踢出旧设备")
      }
      }

      return nil
      }

      // 踢出最旧的设备
      func (s *deviceService) KickOldestDevice(userID uint) error {
      // 1. 获取用户所有设备（按最后活跃时间降序）
      devices, err := s.deviceRepo.GetUserDevices(userID)
      if err != nil {
      return err
      }

      // 2. 选择最旧设备（数组最后一个）
      oldestDevice := devices[len(devices)-1]

      // 3. 删除设备的所有会话（强制下线）
      s.deviceRepo.DeleteDeviceSessions(oldestDevice.DeviceID)

      // 4. 删除设备记录
      return s.deviceRepo.DeleteDevice(oldestDevice.ID)
      }
    </div>

    <h2>3. 强制下线时序图</h2>
    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-number">1</div>
        <div>
          <strong>初始状态</strong><br>
          用户已有5台设备在线（达到上限）
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-number">2</div>
        <div>
          <strong>新设备登录</strong><br>
          第6台设备尝试登录
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-number">3</div>
        <div>
          <strong>检查限制</strong><br>
          系统检测到设备数量超限
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-number">4</div>
        <div>
          <strong>查找目标</strong><br>
          查询所有设备并按最后活跃时间排序
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-number">5</div>
        <div>
          <strong>强制下线</strong><br>
          删除最旧设备的会话和记录
        </div>
      </div>
      <div class="timeline-item">
        <div class="timeline-number">6</div>
        <div>
          <strong>新设备登录</strong><br>
          第6台设备成功登录
        </div>
      </div>
    </div>

    <h2>4. 设备状态变化演示</h2>

    <h3>登录前状态（5台设备）</h3>
    <div class="device-grid">
      <div class="device-card active">
        <strong>iPhone 13 Pro</strong><br>
        <small>最后活跃: 10:00<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>Samsung Galaxy</strong><br>
        <small>最后活跃: 10:30<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>MacBook Pro</strong><br>
        <small>最后活跃: 11:00<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>Chrome Browser</strong><br>
        <small>最后活跃: 11:30<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>微信小程序</strong><br>
        <small>最后活跃: 12:00<br>状态: 在线</small>
      </div>
    </div>

    <h3>第6台设备登录后（强制下线发生）</h3>
    <div class="device-grid">
      <div class="device-card kicked">
        <strong>iPhone 13 Pro</strong><br>
        <small>最后活跃: 10:00<br>状态: 被踢出</small>
      </div>
      <div class="device-card active">
        <strong>Samsung Galaxy</strong><br>
        <small>最后活跃: 10:30<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>MacBook Pro</strong><br>
        <small>最后活跃: 11:00<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>Chrome Browser</strong><br>
        <small>最后活跃: 11:30<br>状态: 在线</small>
      </div>
      <div class="device-card active">
        <strong>微信小程序</strong><br>
        <small>最后活跃: 12:00<br>状态: 在线</small>
      </div>
      <div class="device-card new">
        <strong>iPhone 14</strong><br>
        <small>最后活跃: 12:30<br>状态: 新登录</small>
      </div>
    </div>

    <div class="example">
      <strong>关键观察点：</strong>
      <ul>
        <li>最旧设备（iPhone 13 Pro）被自动踢出</li>
        <li>设备总数保持在5台（限制范围内）</li>
        <li>新设备（iPhone 14）成功登录</li>
        <li>被踢出设备的Token立即失效</li>
      </ul>
    </div>

    <h2>5. 数据库操作详解</h2>
    <div class="code-block">
      -- 1. 查询用户设备（按最后活跃时间降序）
      SELECT * FROM user_devices
      WHERE user_id = ?
      ORDER BY last_active_at DESC;

      -- 2. 删除设备的所有会话
      DELETE FROM user_sessions
      WHERE device_id = ?;

      -- 3. 删除设备记录
      DELETE FROM user_devices
      WHERE id = ?;

      -- 4. 统计用户设备数量
      SELECT COUNT(*) FROM user_devices
      WHERE user_id = ?;
    </div>

    <h2>6. 测试验证</h2>
    <div class="highlight">
      <strong>运行演示脚本：</strong>
      <code>./scripts/demo_force_offline.sh</code>
    </div>

    <p>该脚本会：</p>
    <ul>
      <li>依次登录5台设备</li>
      <li>登录第6台设备触发强制下线</li>
      <li>验证被踢出设备的Token失效</li>
      <li>测试手动踢出设备功能</li>
    </ul>

    <h2>7. 优化建议</h2>
    <div class="example">
      <strong>智能踢出策略：</strong>
      <ul>
        <li><strong>优先离线设备：</strong>优先踢出已离线的设备</li>
        <li><strong>设备类型优先级：</strong>Web < PC < Android < iOS < 小程序</li>
        <li><strong>用户选择：</strong>让用户选择要踢出的设备</li>
        <li><strong>通知机制：</strong>设备被踢出时发送通知</li>
      </ul>
    </div>

    <div class="code-block">
      // 智能选择要踢出的设备
      func (s *deviceService) selectDeviceToKick(devices []*model.UserDevice) *model.UserDevice {
      // 1. 优先选择离线设备
      for _, device := range devices {
      if !device.IsOnline() {
      return device
      }
      }

      // 2. 按设备类型优先级
      typePriority := map[string]int{
      "web": 1, "pc": 2, "android": 3, "ios": 4, "miniprogram": 5,
      }

      // 3. 选择优先级最低的设备
      var targetDevice *model.UserDevice
      minPriority := 999

      for _, device := range devices {
      if priority, exists := typePriority[device.DeviceType]; exists {
      if priority < minPriority { minPriority=priority targetDevice=device } } } // 4. 如果没有找到，返回最旧设备 if
        targetDevice==nil { targetDevice=devices[len(devices)-1] } return targetDevice } </div>
    </div>
</body>

</html>