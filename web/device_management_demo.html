<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>多端设备管理系统 - 演示</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    .section h2 {
      color: #555;
      margin-top: 0;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button.danger {
      background-color: #dc3545;
    }

    button.danger:hover {
      background-color: #c82333;
    }

    .device-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .device-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #fafafa;
    }

    .device-card.online {
      border-color: #28a745;
      background-color: #f8fff9;
    }

    .device-card.offline {
      border-color: #dc3545;
      background-color: #fff8f8;
    }

    .device-type {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      margin-bottom: 10px;
    }

    .device-type.ios {
      background-color: #007bff;
    }

    .device-type.android {
      background-color: #28a745;
    }

    .device-type.pc {
      background-color: #6c757d;
    }

    .device-type.web {
      background-color: #fd7e14;
    }

    .device-type.miniprogram {
      background-color: #20c997;
    }

    .status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      color: white;
      margin-left: 10px;
    }

    .status.online {
      background-color: #28a745;
    }

    .status.offline {
      background-color: #dc3545;
    }

    .response-area {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .device-info {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }

    .device-actions {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>多端设备管理系统 - 演示</h1>

    <!-- 登录区域 -->
    <div class="section">
      <h2>登录测试</h2>
      <div class="form-group">
        <label for="phone">手机号:</label>
        <input type="text" id="phone" value="13800138000" placeholder="请输入手机号">
      </div>
      <div class="form-group">
        <label for="code">验证码:</label>
        <input type="text" id="code" value="123456" placeholder="请输入验证码">
      </div>
      <div class="form-group">
        <label for="deviceType">设备类型:</label>
        <select id="deviceType">
          <option value="web">Web</option>
          <option value="ios">iOS</option>
          <option value="android">Android</option>
          <option value="pc">PC</option>
          <option value="miniprogram">小程序</option>
        </select>
      </div>
      <div class="form-group">
        <label for="deviceName">设备名称:</label>
        <input type="text" id="deviceName" value="Chrome Browser" placeholder="设备名称">
      </div>
      <button onclick="sendSMS()">发送验证码</button>
      <button onclick="login()">登录</button>
      <div id="loginResponse" class="response-area"></div>
    </div>

    <!-- 设备管理区域 -->
    <div class="section">
      <h2>设备管理</h2>
      <button onclick="getDevices()">刷新设备列表</button>
      <button onclick="simulateMultipleDevices()">模拟多设备登录</button>
      <div id="deviceStats" style="margin: 10px 0; padding: 10px; background-color: #e9ecef; border-radius: 4px;"></div>
      <div id="deviceList" class="device-list"></div>
    </div>

    <!-- 用户信息区域 -->
    <div class="section">
      <h2>用户信息</h2>
      <button onclick="getProfile()">获取用户信息</button>
      <div id="profileResponse" class="response-area"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8080/api/v1';
    let currentToken = localStorage.getItem('token') || '';
    let currentDeviceId = localStorage.getItem('device_id') || generateUUID();

    // 生成UUID
    function generateUUID() {
      const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
      localStorage.setItem('device_id', uuid);
      return uuid;
    }

    // 获取设备信息
    function getDeviceInfo() {
      const deviceType = document.getElementById('deviceType').value;
      const deviceName = document.getElementById('deviceName').value;

      return {
        device_id: currentDeviceId,
        device_type: deviceType,
        device_name: deviceName || getDefaultDeviceName(deviceType),
        app_version: '1.0.0',
        os_version: getOSVersion(deviceType)
      };
    }

    function getDefaultDeviceName(deviceType) {
      const names = {
        'web': 'Chrome Browser',
        'ios': 'iPhone',
        'android': 'Android Phone',
        'pc': 'PC Desktop',
        'miniprogram': '微信小程序'
      };
      return names[deviceType] || 'Unknown Device';
    }

    function getOSVersion(deviceType) {
      const versions = {
        'web': 'Chrome 96.0',
        'ios': 'iOS 15.0',
        'android': 'Android 11',
        'pc': 'Windows 10',
        'miniprogram': 'WeChat 8.0'
      };
      return versions[deviceType] || 'Unknown';
    }

    // 发送短信验证码
    async function sendSMS() {
      const phone = document.getElementById('phone').value;

      try {
        const response = await fetch(`${API_BASE}/sms/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            phone: phone,
            purpose: 'login'
          })
        });

        const result = await response.json();
        document.getElementById('loginResponse').textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById('loginResponse').textContent = `错误: ${error.message}`;
      }
    }

    // 登录
    async function login() {
      const phone = document.getElementById('phone').value;
      const code = document.getElementById('code').value;
      const deviceInfo = getDeviceInfo();

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            phone: phone,
            code: code,
            device_info: deviceInfo
          })
        });

        const result = await response.json();
        document.getElementById('loginResponse').textContent = JSON.stringify(result, null, 2);

        if (result.code === 200 && result.data && result.data.token) {
          currentToken = result.data.token;
          localStorage.setItem('token', currentToken);
          alert('登录成功！');
          getDevices(); // 自动刷新设备列表
        }
      } catch (error) {
        document.getElementById('loginResponse').textContent = `错误: ${error.message}`;
      }
    }

    // 获取设备列表
    async function getDevices() {
      if (!currentToken) {
        alert('请先登录');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/users/devices`, {
          headers: {
            'Authorization': `Bearer ${currentToken}`
          }
        });

        const result = await response.json();

        if (result.code === 200) {
          displayDevices(result.data);
        } else {
          alert(`获取设备列表失败: ${result.message}`);
        }
      } catch (error) {
        alert(`错误: ${error.message}`);
      }
    }

    // 显示设备列表
    function displayDevices(data) {
      const deviceList = document.getElementById('deviceList');
      const deviceStats = document.getElementById('deviceStats');

      // 显示统计信息
      deviceStats.innerHTML = `
                <strong>设备统计:</strong> 
                总设备数: ${data.total_count} | 
                在线设备: ${data.online_count} | 
                最大允许: ${data.max_devices}
            `;

      // 显示设备列表
      deviceList.innerHTML = '';

      data.devices.forEach(device => {
        const deviceCard = document.createElement('div');
        deviceCard.className = `device-card ${device.is_online ? 'online' : 'offline'}`;

        deviceCard.innerHTML = `
                    <div>
                        <span class="device-type ${device.device_type}">${device.device_type.toUpperCase()}</span>
                        <span class="status ${device.is_online ? 'online' : 'offline'}">
                            ${device.is_online ? '在线' : '离线'}
                        </span>
                    </div>
                    <div><strong>${device.device_name}</strong></div>
                    <div class="device-info">设备ID: ${device.device_id}</div>
                    <div class="device-info">应用版本: ${device.app_version}</div>
                    <div class="device-info">系统版本: ${device.os_version}</div>
                    <div class="device-info">IP地址: ${device.client_ip}</div>
                    <div class="device-info">登录时间: ${new Date(device.login_at).toLocaleString()}</div>
                    <div class="device-info">最后活跃: ${new Date(device.last_active_at).toLocaleString()}</div>
                    <div class="device-actions">
                        <button class="danger" onclick="kickDevice('${device.device_id}')">踢出设备</button>
                    </div>
                `;

        deviceList.appendChild(deviceCard);
      });
    }

    // 踢出设备
    async function kickDevice(deviceId) {
      if (!currentToken) {
        alert('请先登录');
        return;
      }

      if (!confirm('确定要踢出这个设备吗？')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/users/devices/kick`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            device_ids: [deviceId]
          })
        });

        const result = await response.json();

        if (result.code === 200) {
          alert('设备已被踢出');
          getDevices(); // 刷新设备列表
        } else {
          alert(`踢出设备失败: ${result.message}`);
        }
      } catch (error) {
        alert(`错误: ${error.message}`);
      }
    }

    // 模拟多设备登录
    async function simulateMultipleDevices() {
      const phone = document.getElementById('phone').value;
      const code = document.getElementById('code').value;

      if (!phone || !code) {
        alert('请先输入手机号和验证码');
        return;
      }

      const devices = [
        { type: 'ios', name: 'iPhone 13 Pro', os: 'iOS 15.0' },
        { type: 'android', name: 'Samsung Galaxy S21', os: 'Android 11' },
        { type: 'pc', name: 'MacBook Pro', os: 'macOS 12.0' },
        { type: 'miniprogram', name: '微信小程序', os: 'WeChat 8.0' },
        { type: 'web', name: 'Chrome Browser', os: 'Chrome 96.0' },
        { type: 'ios', name: 'iPhone 14', os: 'iOS 16.0' } // 这个会触发设备限制
      ];

      for (let i = 0; i < devices.length; i++) {
        const device = devices[i];
        const deviceInfo = {
          device_id: `${device.type}_device_${i + 1}`,
          device_type: device.type,
          device_name: device.name,
          app_version: '1.0.0',
          os_version: device.os
        };

        try {
          const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              phone: phone,
              code: code,
              device_info: deviceInfo
            })
          });

          const result = await response.json();
          console.log(`设备 ${i + 1} 登录结果:`, result);

          if (result.code === 200 && result.data && result.data.token) {
            currentToken = result.data.token;
            localStorage.setItem('token', currentToken);
          }

          // 延迟一秒再登录下一个设备
          await new Promise(resolve => setTimeout(resolve, 1000));
        } catch (error) {
          console.error(`设备 ${i + 1} 登录失败:`, error);
        }
      }

      alert('多设备登录完成，请查看设备列表');
      getDevices();
    }

    // 获取用户信息
    async function getProfile() {
      if (!currentToken) {
        alert('请先登录');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/users/profile`, {
          headers: {
            'Authorization': `Bearer ${currentToken}`
          }
        });

        const result = await response.json();
        document.getElementById('profileResponse').textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById('profileResponse').textContent = `错误: ${error.message}`;
      }
    }

    // 页面加载时初始化
    window.onload = function () {
      // 设置设备名称
      document.getElementById('deviceName').value = getDefaultDeviceName('web');

      // 如果有token，自动获取设备列表
      if (currentToken) {
        getDevices();
      }
    };
  </script>
</body>

</html>